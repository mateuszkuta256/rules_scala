load("//scala:scala.bzl", "scala_binary")
load("//scala/scalafmt/toolchain:toolchain.bzl", "export_scalafmt_deps")
load("//scala/scalafmt:setup_scalafmt_toolchain.bzl", "setup_scalafmt_toolchain")
load("@io_bazel_rules_scala//scala:providers.bzl", "declare_deps_provider")
load(
    "//scala/scalafmt:phase_scalafmt_ext.bzl",
    "scalafmt_singleton",
)

filegroup(
    name = "runner",
    srcs = ["private/format.template.sh"],
    visibility = ["//visibility:public"],
)

filegroup(
    name = "testrunner",
    srcs = ["private/format-test.template.sh"],
    visibility = ["//visibility:public"],
)

scala_binary(
    name = "scalafmt",
    srcs = ["scalafmt/ScalafmtWorker.scala"],
    main_class = "io.bazel.rules_scala.scalafmt.ScalafmtWorker",
    visibility = ["//visibility:public"],
    deps = [
        ":scalafmt_classpath",
        "//src/java/io/bazel/rulesscala/worker",
    ],
)

scala_binary(
    name = "scala3-hello",
    scala_version = "3_3_0",
    srcs = ["scalafmt/Main.scala"],
    main_class = "hello",
)

scalafmt_singleton(
    name = "phase_scalafmt",
    visibility = ["//visibility:public"],
)

setup_scalafmt_toolchain(
    name = "scalafmt_toolchain",
    scalafmt_classpath = [
        "@com_geirsson_metaconfig_core",
        "@org_scalameta_common",
        "@org_scalameta_parsers",
        "@org_scalameta_scalafmt_core",
        "@org_scalameta_scalameta",
        "@org_scalameta_trees",
    ]
)

setup_scalafmt_toolchain(
    name = "scalafmt_toolchain_2_13_12",
    scala_version = "2_13_12",
    scalafmt_classpath = [
        "@com_geirsson_metaconfig_core_2_13_12",
        "@org_scalameta_common_2_13_12",
        "@org_scalameta_parsers_2_13_12",
        "@org_scalameta_scalafmt_core_2_13_12",
        "@org_scalameta_scalameta_2_13_12",
        "@org_scalameta_trees_2_13_12",
    ]
)

declare_deps_provider(
    name = "scalafmt_classpath_provider",
    deps_id = "scalafmt_classpath",
    visibility = ["//visibility:public"],
    deps = [
        "@com_geirsson_metaconfig_core",
        "@org_scalameta_common",
        "@org_scalameta_parsers",
        "@org_scalameta_scalafmt_core",
        "@org_scalameta_scalameta",
        "@org_scalameta_trees",
    ],
)

export_scalafmt_deps(
    name = "scalafmt_classpath",
    deps_id = "scalafmt_classpath",
    visibility = ["//visibility:public"],
)
